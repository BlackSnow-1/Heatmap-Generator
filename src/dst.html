<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>数据展示</title>

  <link rel="stylesheet" href="./static/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .card-rect {
      fill: #ffffff;
      stroke: #3a6cff;
      stroke-width: 2;
      rx: 6;
      ry: 6;
    }

    .card-text {
      font-size: 14px;
      fill: #000;
      pointer-events: none;
    }

    .card-title {
      font-weight: bold;
    }

    .line {
      stroke: #3a6cff;
      stroke-width: 2;
      fill: none;
    }

    .point {
      fill: #3a6cff;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- XLSX 文件选择 -->
<div style="position:absolute;top:10px;left:10px;z-index:1000;">
  <input type="file" id="xlsxInput" accept=".xlsx,.xls"/>
</div>

<script src="./static/leaflet.js"></script>
<script src="./static/xlsx.full.min.js"></script>

<script>
/* =====================================================
   1. 地图初始化
===================================================== */
const map = L.map('map').setView([20, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  noWrap: true,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

/* =====================================================
   2. SVG 覆盖层
===================================================== */
L.svg().addTo(map);
const svg = map.getPanes().overlayPane.querySelector('svg');
const svgItems = [];

const CARD_W = 180;
const CARD_H = 90;

/* =====================================================
   3. Excel 读取
===================================================== */
document.getElementById('xlsxInput').addEventListener('change', handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });

    processExcelData(rows);
  };

  reader.readAsArrayBuffer(file);
}

/* =====================================================
   4. Excel → SVG 元素
===================================================== */
function processExcelData(rows) {
  // 清空旧数据
  svg.innerHTML = '';
  svgItems.length = 0;

  rows.forEach(row => {
    if (!row.纬度 || !row.经度) return;
    svgItems.push(createItem(row));
  });

  updateAll();
}

/* =====================================================
   5. 创建单条数据的 SVG 组件
===================================================== */
function createItem(row) {
  const pointLatLng = [row.纬度, row.经度];
  const cardLatLng = [row.纬度 + 5, row.经度 + 10];

  // 点
  const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  point.setAttribute('r', 5);
  point.setAttribute('class', 'point');
  svg.appendChild(point);

  // 折线
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
  line.setAttribute('class', 'line');
  svg.appendChild(line);

  // 卡片
  const card = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  svg.appendChild(card);

  const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
  rect.setAttribute('class', 'card-rect');
  rect.setAttribute('width', CARD_W);
  rect.setAttribute('height', CARD_H);
  card.appendChild(rect);

  [
    `（一）${row.国家}`,
    `出口：${row.出口} 亿元`,
    `增幅：${row.增幅}%`,
    `占比：${row.占比 ?? '-'}%`
  ].forEach((txt, i) => {
    const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    t.setAttribute('x', 12);
    t.setAttribute('y', 22 + i * 18);
    t.setAttribute('class', `card-text ${i === 0 ? 'card-title' : ''}`);
    t.textContent = txt;
    card.appendChild(t);
  });

  return { pointLatLng, cardLatLng, point, line, card };
}

/* =====================================================
   6. 统一更新（缩放 / 平移）
===================================================== */
function updateAll() {
  svgItems.forEach(item => {
    const p = map.latLngToLayerPoint(item.pointLatLng);
    const c = map.latLngToLayerPoint(item.cardLatLng);

    item.point.setAttribute('cx', p.x);
    item.point.setAttribute('cy', p.y);

    item.card.setAttribute('transform', `translate(${c.x}, ${c.y})`);

    const midY = c.y + CARD_H / 2;
    item.line.setAttribute(
      'points',
      `${p.x},${p.y} ${p.x},${midY} ${c.x},${midY}`
    );
  });
}

map.on('zoom move', updateAll);
</script>

</body>
</html>
