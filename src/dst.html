<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Leaflet SVG å‚ç›´æŠ˜çº¿å¡ç‰‡</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .card-rect {
      fill: #ffffff;
      stroke: #3a6cff;
      stroke-width: 2;
      rx: 6;
      ry: 6;
    }

    .card-text {
      font-size: 14px;
      fill: #000;
      pointer-events: none;
    }

    .card-title {
      font-weight: bold;
    }

    .line {
      stroke: #3a6cff;
      stroke-width: 2;
      fill: none;
    }

    .point {
      fill: #3a6cff;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<div style="position:absolute;top:10px;left:10px;z-index:1000;">
  <input type="file" id="xlsxInput" accept=".xlsx,.xls" />
</div>

<script>
document.getElementById('xlsxInput').addEventListener('change', handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (evt) {
    const data = new Uint8Array(evt.target.result);

    // è¯»å– workbook
    const workbook = XLSX.read(data, { type: 'array' });

    // é»˜è®¤è¯»ç¬¬ä¸€ä¸ª sheet
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];

    // è½¬ä¸º JSON
    const json = XLSX.utils.sheet_to_json(sheet, {
      defval: null   // ç©ºå•å…ƒæ ¼ä¸ä¸¢
    });

    console.log('Excel æ•°æ®ï¼š', json);

    // ğŸ‘‰ è¿™é‡Œå°±æ˜¯ä½ åç»­æ¥åœ°å›¾çš„å…¥å£
    processExcelData(json);
  };

  reader.readAsArrayBuffer(file);
}

function processExcelData(rows) {
  /*
    rows ç¤ºä¾‹ï¼š
    [
      { å›½å®¶: "å°åº¦", çº¬åº¦: 28.6, ç»åº¦: 77.2, å‡ºå£: 41.6, å¢å¹…: 24.6 },
      { å›½å®¶: "ç¾å›½", çº¬åº¦: 38.0, ç»åº¦: -97.0, å‡ºå£: 55.2, å¢å¹…: 12.1 }
    ]
  */

  rows.forEach(row => {
    console.log(row.å›½å®¶, row.çº¬åº¦, row.ç»åº¦);
    // ğŸ‘‰ è¿™é‡Œå¯ä»¥ï¼š
    // - ç”Ÿæˆåœ°å›¾ç‚¹
    // - ç”Ÿæˆå¡ç‰‡
    // - ç”ŸæˆæŠ˜çº¿
  });
}
</script>


<!--  åœ°å›¾ç»˜åˆ¶éƒ¨åˆ† -->
<script>
/* =========================
   åœ°å›¾åˆå§‹åŒ–
========================= */
const map = L.map('map').setView([0, 0], 2);
//
//
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  noWrap: true,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);





/* =========================
   æ•°æ®
========================= */
const pointLatLng = [28.6139, 77.2090];
const cardLatLng  = [33.0, 63.0];

const CARD_W = 180;
const CARD_H = 90;

/* =========================
   SVG Layer
========================= */
L.svg().addTo(map);
const svg = map.getPanes().overlayPane.querySelector('svg');

/* =========================
   å…ƒç´ åˆ›å»º
========================= */

// ç‚¹
const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
point.setAttribute('r', 5);
point.setAttribute('class', 'point');
svg.appendChild(point);

// æŠ˜çº¿
const line = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
line.setAttribute('class', 'line');
svg.appendChild(line);

// å¡ç‰‡ï¼ˆg å®¹å™¨ï¼‰
const card = document.createElementNS('http://www.w3.org/2000/svg', 'g');
svg.appendChild(card);

// å¡ç‰‡èƒŒæ™¯
const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
rect.setAttribute('class', 'card-rect');
rect.setAttribute('width', CARD_W);
rect.setAttribute('height', CARD_H);
card.appendChild(rect);

// æ–‡æœ¬
[
  { y: 22, text: 'ï¼ˆä¸€ï¼‰å°åº¦', cls: 'card-title' },
  { y: 44, text: 'å‡ºå£ï¼š41.6 äº¿å…ƒ' },
  { y: 62, text: 'å¢å¹…ï¼š24.6%' },
  { y: 80, text: 'å æ¯”ï¼š27.9%' }
].forEach(r => {
  const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  t.setAttribute('x', 12);
  t.setAttribute('y', r.y);
  t.setAttribute('class', `card-text ${r.cls || ''}`);
  t.textContent = r.text;
  card.appendChild(t);
});

/* =========================
   æ›´æ–°å‡½æ•°ï¼ˆæ ¸å¿ƒï¼‰
========================= */
function update() {
  const p = map.latLngToLayerPoint(pointLatLng);
  const c = map.latLngToLayerPoint(cardLatLng);

  // ç‚¹
  point.setAttribute('cx', p.x);
  point.setAttribute('cy', p.y);

  // å¡ç‰‡ä½ç½®ï¼ˆå·¦ä¸Šè§’ï¼‰
  card.setAttribute(
    'transform',
    `translate(${c.x}, ${c.y})`
  );

  // æŠ˜çº¿ï¼šç«–ç›´ â†’ æ°´å¹³
  const midY = c.y + CARD_H / 2;

  line.setAttribute(
    'points',
    `
      ${p.x},${p.y}
      ${p.x},${midY}
      ${c.x},${midY}
    `
  );
}

/* =========================
   äº‹ä»¶
========================= */
map.on('zoom move zoomend moveend', update);
update();
</script>

</body>
</html>
